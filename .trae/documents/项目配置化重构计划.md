## 项目重构目标

1. **支持YAML配置文件**：实现完整的YAML配置支持，包含大模型、嵌入服务和Chroma配置
2. **高可配置化**：所有关键参数均可通过配置调整，无需修改代码
3. **单机单进程**：保持轻量化设计，不引入高资源消耗组件
4. **统一日志系统**：实现适合线上环境的统一日志管理
5. **时区支持**：默认中国时区，支持用户自定义配置
6. **环境变量覆盖**：支持通过环境变量灵活覆盖配置项

## 重构方案

### 1. 配置系统重构

#### 1.1 引入YAML配置支持
- 创建`config.example.yaml`作为配置模板
- 支持配置文件路径通过环境变量`CONFIG_PATH`指定
- 实现配置文件与环境变量的优先级合并

#### 1.2 嵌套Pydantic配置模型
```python
class LLMConfig(BaseSettings):
    model: str = "glm-4-flash"
    api_key: str = ""
    base_url: Optional[str] = None
    timeout: int = 360
    max_retries: int = 3
    temperature: float = 0.1
    max_tokens: int = 2048

class EmbeddingConfig(BaseSettings):
    model: str = "embedding-3"
    api_key: str = ""
    base_url: Optional[str] = None
    timeout: int = 30
    max_retries: int = 3
    dimension: int = 1536
    normalize: bool = True

class ChromaConfig(BaseSettings):
    host: str = "localhost"
    port: int = 8999
    collection_name: str = "prompts"
    timeout: int = 30
    persist_directory: Optional[str] = None
    use_persistent_client: bool = True

class Settings(BaseSettings):
    # 应用配置
    app: AppConfig = AppConfig()
    # 数据库配置
    database: DatabaseConfig = DatabaseConfig()
    # 大模型配置
    llm: LLMConfig = LLMConfig()
    # 嵌入服务配置
    embedding: EmbeddingConfig = EmbeddingConfig()
    # Chroma配置
    chroma: ChromaConfig = ChromaConfig()
    # 时区配置
    timezone: str = "Asia/Shanghai"
```

### 2. 统一日志系统

#### 2.1 配置日志系统
- 使用Python标准日志库，支持JSON格式日志
- 支持日志级别、格式、输出方式配置
- 配置文件中增加日志配置项
- 实现日志文件滚动，避免日志过大

#### 2.2 日志使用规范
- 所有模块使用统一的日志配置
- 日志格式包含：时间戳、模块名、日志级别、消息内容
- 支持请求追踪ID，便于日志关联

### 3. 时区支持实现

#### 3.1 配置时区选项
- 在配置文件中增加`timezone`配置项
- 默认值设为`Asia/Shanghai`
- 支持通过环境变量`TIMEZONE`覆盖

#### 3.2 统一时区使用
- 在代码中使用配置的时区
- 所有时间相关操作统一使用配置时区
- 实现时区工具函数，便于时区转换

### 4. 服务初始化重构

#### 4.1 LLM服务初始化
- 根据配置初始化LLM服务
- 支持不同LLM提供商
- 实现配置验证

#### 4.2 Embedding服务初始化
- 根据配置初始化Embedding服务
- 支持嵌入向量归一化配置
- 实现嵌入缓存配置

#### 4.3 Chroma服务初始化
- 支持远程Chroma客户端
- 支持本地持久化Chroma客户端
- 根据配置自动选择客户端类型

### 5. 代码结构优化

#### 5.1 模块化设计
- 将配置相关代码独立到`app/core/config.py`
- 将日志相关代码独立到`app/core/logging.py`
- 将时区相关代码独立到`app/utils/timezone.py`

#### 5.2 依赖注入优化
- 使用依赖注入模式管理服务实例
- 减少全局变量使用
- 提高代码可测试性

## 实现步骤

1. **修改配置系统**：重构`app/core/config.py`，支持YAML配置
2. **添加日志配置**：创建`app/core/logging.py`，实现统一日志
3. **添加时区支持**：创建`app/utils/timezone.py`，实现时区工具
4. **更新服务初始化**：修改各服务初始化逻辑，使用新配置
5. **更新定时任务**：修改定时任务调度，支持时区配置
6. **创建配置模板**：创建`config.example.yaml`作为配置模板
7. **更新文档**：更新README.md，添加配置说明
8. **测试验证**：测试所有配置项是否正常工作

## 预期效果

1. **高度可配置**：所有关键参数均可通过YAML配置文件调整
2. **灵活部署**：支持不同环境的配置文件
3. **资源高效**：保持单机单进程，无额外资源消耗
4. **线上友好**：统一日志格式，便于日志收集和分析
5. **时区支持**：适应不同地区用户需求
6. **易于扩展**：模块化设计，便于添加新功能

## 技术栈

- **FastAPI**：Web框架
- **Pydantic**：数据验证和配置管理
- **PyYAML**：YAML配置支持
- **Python标准库**：日志、时区等基础功能
- **SQLite**：轻量级数据库
- **Chroma**：向量数据库，支持本地和远程模式