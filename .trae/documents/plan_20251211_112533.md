# 记忆系统优化设计方案

## 问题分析

1. **当前系统问题**：
   - 记忆内容直接存储原始对话记录，没有进行总结和提取
   - 相似度计算使用关键词匹配，准确性低
   - 缺乏对不同app的差异化记忆提取配置
   - 记忆提取结构不够灵活

2. **用户需求**：
   - 为不同app配置不同的记忆提取结构
   - 对话记忆单独存储，记忆应该是总结和提取
   - 使用更可信的相似度计算方法
   - 保持单机单进程，轻量化设计

## 设计方案

### 1. 架构设计

保持现有的数据库结构，优化核心逻辑：

```
┌─────────────────┐     ┌─────────────────┐     ┌─────────────────┐
│   对话记录存储   │     │   记忆生成引擎   │     │   记忆存储与检索  │
│  (ChatHistory)  │────▶│ (MemoryManager)  │────▶│ (UserMemory +  │
└─────────────────┘     └─────────────────┘     │  MemoryEmbedding│
                                               └─────────────────┘
```

### 2. 核心功能优化

#### 2.1 对话记忆与提取记忆分离

- **对话记录**：单独存储在`ChatHistory`表，保留原始对话
- **提取记忆**：存储在`UserMemory`表，是对对话的总结和提取结果
- **记忆生成流程**：
  1. 存储原始对话到`ChatHistory`
  2. 调用LLM对对话进行总结
  3. 提取关键要素
  4. 生成记忆并存储到`UserMemory`

#### 2.2 差异化app记忆提取配置

增强`BusinessTemplate`表，支持：
- 不同app的专属提取模板
- 自定义提取要素结构
- 优先级配置
- 提取规则

#### 2.3 基于嵌入向量的相似度计算

- 使用Chroma向量数据库存储记忆嵌入
- 基于余弦相似度计算记忆相似度
- 确保相似度计算的准确性和可信度

### 3. 实现计划

#### 3.1 优化记忆生成逻辑

- **修改`create_memory`方法**：确保记忆内容是总结后的结果
- **增强`extract_elements`方法**：支持不同app的差异化提取
- **添加`summarize_dialogue`方法**：对对话进行总结

#### 3.2 修复相似度计算

- **修改`query_memories`方法**：使用基于嵌入向量的相似度计算
- **移除关键词匹配逻辑**：使用Chroma的内置相似度计算

#### 3.3 增强配置管理

- **优化`BusinessTemplate`模型**：支持更多配置选项
- **增强`MemoryConfig`表**：为不同app配置不同的记忆提取策略

#### 3.4 完善API接口

- **保留现有API**：确保向后兼容
- **优化API返回**：返回更有用的记忆信息

### 4. 预期效果

1. **记忆质量提升**：记忆内容是总结和提取的结果，而非原始对话
2. **相似度准确性提升**：基于嵌入向量的相似度计算更可信
3. **灵活性增强**：支持不同app的差异化配置
4. **性能优化**：保持轻量化设计，不引入额外组件
5. **API兼容性**：保持现有API不变，确保平滑升级

## 技术栈

- 保持现有技术栈不变
- 不引入Redis、MQ等组件
- 增强现有组件的功能

## 实现步骤

1. 优化记忆生成逻辑
2. 修复相似度计算
3. 增强配置管理
4. 测试和验证
5. 文档更新

这个设计方案将解决当前系统的问题，满足用户的需求，同时保持系统的轻量化和单机单进程设计。