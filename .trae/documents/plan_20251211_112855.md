# 记忆系统最佳设计方案

## 1. 系统架构设计

### 1.1 核心架构

保持单机单进程设计，基于以下核心组件：

```
┌─────────────────┐     ┌─────────────────┐     ┌─────────────────┐
│   API层         │     │   服务层        │     │   数据层        │
│  (FastAPI)      │────▶│ (MemoryManager)  │────▶│ (SQLite +      │
└─────────────────┘     │ (Embedding)     │     │  Chroma)       │
                        │ (LLM Service)    │     └─────────────────┘
                        └─────────────────┘
```

### 1.2 关键改进点

1. **对话记忆与提取记忆分离**
2. **基于嵌入向量的相似度计算**
3. **应用级配置管理**
4. **可视化配置界面**
5. **轻量化设计**

## 2. 数据库设计

### 2.1 现有模型优化

#### `UserMemory` 表
- **用途**：存储提取后的记忆（总结+要素）
- **核心字段**：`id`, `user_id`, `app_name`, `memory_content`, `extracted_elements`, `memory_priority`, `memory_tags`, `last_accessed_at`, `created_at`, `updated_at`, `is_active`

#### `ChatHistory` 表
- **用途**：单独存储原始对话记录
- **核心字段**：`id`, `user_id`, `app_name`, `session_id`, `role`, `content`, `timestamp`

#### `AppConfig` 表（新增）
- **用途**：存储应用级配置
- **核心字段**：`id`, `app_name`, `extraction_template`, `conversation_rounds`, `max_summary_length`, `enable_auto_summarize`, `enable_element_extraction`, `similarity_threshold`, `priority_weights`

#### `BusinessTemplate` 表
- **用途**：存储不同业务场景的提取模板
- **核心字段**：`id`, `template_name`, `app_name`, `extraction_prompt`, `priority_fields`, `is_default`

#### `UserAppConfig` 表（新增）
- **用途**：存储用户级应用配置
- **核心字段**：`id`, `user_id`, `app_name`, `app_config_id`, `use_default`, `custom_config`

## 3. 核心功能设计

### 3.1 记忆生成流程

```
1. 用户提交对话
2. 存储原始对话到 ChatHistory
3. 检查对话轮数：
   - 如果达到配置的轮数，调用 LLM 总结
   - 提取关键要素
   - 生成记忆并存储到 UserMemory
4. 生成嵌入向量并存储到 Chroma
```

### 3.2 应用级配置管理

- **配置项**：
  - 提取模板
  - 对话更新轮数
  - 最大总结长度
  - 是否启用自动总结
  - 是否启用要素提取
  - 相似度阈值
  - 优先级权重

### 3.3 可视化配置界面

在前端添加配置页面，允许用户：
- 选择应用
- 编辑提取模板
- 设置对话轮数
- 配置总结长度
- 调整相似度阈值
- 保存配置到数据库

### 3.4 相似度计算

- 使用 Chroma 向量数据库存储记忆嵌入
- 基于余弦相似度计算
- 支持配置相似度阈值

## 4. 配置管理设计

### 4.1 配置层次

1. **通用配置**：存储在 `config.yaml`，包括：
   - 应用基本信息
   - 数据库配置
   - LLM 配置
   - Embedding 配置
   - Chroma 配置
   - 日志配置

2. **应用配置**：存储在数据库 `AppConfig` 表，包括：
   - 应用特定的提取模板
   - 对话轮数
   - 总结长度
   - 相似度阈值

3. **用户应用配置**：存储在数据库 `UserAppConfig` 表，包括：
   - 用户对应用的个性化配置
   - 是否使用默认配置
   - 自定义配置

### 4.2 配置加载流程

```
1. 启动时加载 config.yaml 中的通用配置
2. API 请求时，根据 app_name 从数据库加载应用配置
3. 结合用户配置，生成最终配置
```

## 5. 前端设计

### 5.1 主要页面

1. **聊天提交页面**：提交聊天记录
2. **记忆查询页面**：查询相似记忆
3. **记忆管理页面**：查看和删除记忆
4. **配置页面**：可视化编辑应用配置

### 5.2 配置页面功能

- 选择应用
- 编辑提取模板
- 设置对话轮数
- 配置总结长度
- 调整相似度阈值
- 保存配置到数据库

## 6. 实现步骤

### 6.1 数据库迁移

1. 创建 `AppConfig` 和 `UserAppConfig` 表
2. 更新现有表结构
3. 迁移数据

### 6.2 核心功能实现

1. 优化记忆生成逻辑
2. 实现应用级配置管理
3. 修复相似度计算
4. 开发可视化配置界面
5. 集成配置管理

### 6.3 测试和验证

1. 测试记忆生成流程
2. 测试相似度计算
3. 测试配置管理
4. 测试可视化界面

## 7. 技术栈

- **后端**：FastAPI, SQLAlchemy, Pydantic
- **数据库**：SQLite, Chroma
- **前端**：Bootstrap 5, jQuery
- **LLM/Embedding**：OpenAI/智谱AI API

## 8. 优势

1. **轻量化**：单机单进程，无额外依赖
2. **灵活配置**：支持应用级和用户级配置
3. **可视化界面**：方便用户编辑配置
4. **高效记忆管理**：对话与记忆分离，基于嵌入向量的相似度计算
5. **可扩展性**：模块化设计，易于扩展新功能

这个设计方案满足了用户的所有需求，同时保持了系统的轻量化和单机单进程设计。