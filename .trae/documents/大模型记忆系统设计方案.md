# 大模型记忆系统设计方案

## 1. 系统架构

### 技术栈
- **框架**: FastAPI
- **数据库**: SQLite3 (轻量级，适合快速部署)
- **向量数据库**: Chroma (客户端访问，通用server)
- **大模型**: 支持OpenAI/Anthropic/本地模型等多种大模型集成
- **Embedding**: 支持OpenAI/Google/开源Embedding模型

### 目录结构
```
app/
├── api/                    # API路由
│   ├── __init__.py
│   ├── memory.py           # 记忆相关接口
│   └── config.py           # 配置接口
├── core/                   # 核心配置
│   ├── __init__.py
│   ├── config.py           # 全局配置
│   └── settings.py         # 设置管理
├── crud/                   # 数据库操作
│   ├── __init__.py
│   ├── memory.py           # 记忆CRUD
│   ├── chat.py             # 聊天历史CRUD
│   └── config.py           # 配置CRUD
├── db/                     # 数据库相关
│   ├── __init__.py
│   ├── base.py             # 数据库基类
│   └── session.py          # 数据库会话
├── models/                 # 数据模型
│   ├── __init__.py
│   ├── memory.py           # 记忆模型
│   ├── chat.py             # 聊天历史模型
│   └── config.py           # 配置模型
├── schemas/                # Schema定义
│   ├── __init__.py
│   ├── memory.py           # 记忆Schema
│   ├── chat.py             # 聊天历史Schema
│   └── config.py           # 配置Schema
├── services/               # 业务逻辑服务
│   ├── __init__.py
│   ├── embedding/          # Embedding服务
│   │   ├── __init__.py
│   │   └── base.py         # Embedding基类
│   ├── llm/                # 大模型服务
│   │   ├── __init__.py
│   │   └── base.py         # LLM基类
│   ├── memory/             # 记忆管理
│   │   ├── __init__.py
│   │   ├── manager.py      # 记忆管理器
│   │   ├── extractor.py    # 要素抽取
│   │   └── merger.py       # 重复合并
│   └── chroma/             # Chroma客户端
│       ├── __init__.py
│       └── client.py       # Chroma客户端
├── utils/                  # 工具函数
│   ├── __init__.py
│   ├── time.py             # 时间工具
│   └── validation.py       # 验证工具
└── main.py                 # 应用入口
requirements.txt            # 依赖文件
README.md                   # 说明文档
```

## 2. 数据模型设计

### 2.1 UserMemory 表
| 字段名 | 类型 | 说明 |
|--------|------|------|
| id | INTEGER | 主键 |
| user_id | TEXT | 用户ID |
| app_name | TEXT | 应用名称 |
| memory_content | TEXT | 记忆内容 |
| extracted_elements | JSON | 抽取的要素 |
| created_at | TIMESTAMP | 创建时间 |
| updated_at | TIMESTAMP | 更新时间 |
| last_accessed_at | TIMESTAMP | 最后访问时间 |
| expiry_time | TIMESTAMP | 过期时间 |
| is_active | BOOLEAN | 是否激活 |

### 2.2 ChatHistory 表
| 字段名 | 类型 | 说明 |
|--------|------|------|
| id | INTEGER | 主键 |
| user_id | TEXT | 用户ID |
| app_name | TEXT | 应用名称 |
| role | TEXT | 角色（user/assistant） |
| content | TEXT | 聊天内容 |
| timestamp | TIMESTAMP | 时间戳 |

### 2.3 MemoryConfig 表
| 字段名 | 类型 | 说明 |
|--------|------|------|
| id | INTEGER | 主键 |
| user_id | TEXT | 用户ID |
| app_name | TEXT | 应用名称 |
| extraction_prompt | TEXT | 要素抽取提示词 |
| merge_threshold | FLOAT | 重复合并阈值 |
| expiry_strategy | TEXT | 过期策略（never/last_access） |
| expiry_days | INTEGER | 过期天数 |
| created_at | TIMESTAMP | 创建时间 |
| updated_at | TIMESTAMP | 更新时间 |

### 2.4 MemoryEmbedding 表
| 字段名 | 类型 | 说明 |
|--------|------|------|
| id | INTEGER | 主键 |
| memory_id | INTEGER | 记忆ID |
| embedding_vector | BLOB | Embedding向量 |
| created_at | TIMESTAMP | 创建时间 |

## 3. API设计

### 3.1 提交聊天历史
- **路径**: `/api/memory/submit`
- **方法**: `POST`
- **请求体**:
  ```json
  {
    "user_id": "string",
    "app_name": "string",
    "chat_history": [
      {
        "role": "user",
        "content": "string",
        "timestamp": "2023-01-01T00:00:00Z"
      },
      {
        "role": "assistant",
        "content": "string",
        "timestamp": "2023-01-01T00:00:00Z"
      }
    ]
  }
  ```
- **响应**:
  ```json
  {
    "success": true,
    "message": "Chat history submitted successfully",
    "memory_id": 1
  }
  ```

### 3.2 查询记忆
- **路径**: `/api/memory/query`
- **方法**: `POST`
- **请求体**:
  ```json
  {
    "user_id": "string",
    "app_name": "string",
    "query": "string",
    "top_k": 5
  }
  ```
- **响应**:
  ```json
  {
    "success": true,
    "message": "Memory queried successfully",
    "results": [
      {
        "memory_id": 1,
        "memory_content": "string",
        "extracted_elements": {},
        "similarity": 0.95,
        "created_at": "2023-01-01T00:00:00Z"
      }
    ]
  }
  ```

### 3.3 删除记忆
- **路径**: `/api/memory/{memory_id}`
- **方法**: `DELETE`
- **请求参数**:
  - `memory_id`: 记忆ID
- **响应**:
  ```json
  {
    "success": true,
    "message": "Memory deleted successfully"
  }
  ```

### 3.4 获取记忆配置
- **路径**: `/api/memory/config`
- **方法**: `GET`
- **请求参数**:
  - `user_id`: 用户ID
  - `app_name`: 应用名称
- **响应**:
  ```json
  {
    "success": true,
    "message": "Config retrieved successfully",
    "config": {
      "extraction_prompt": "string",
      "merge_threshold": 0.8,
      "expiry_strategy": "last_access",
      "expiry_days": 30
    }
  }
  ```

### 3.5 更新记忆配置
- **路径**: `/api/memory/config`
- **方法**: `PUT`
- **请求体**:
  ```json
  {
    "user_id": "string",
    "app_name": "string",
    "config": {
      "extraction_prompt": "string",
      "merge_threshold": 0.8,
      "expiry_strategy": "last_access",
      "expiry_days": 30
    }
  }
  ```
- **响应**:
  ```json
  {
    "success": true,
    "message": "Config updated successfully"
  }
  ```

## 4. 核心服务设计

### 4.1 EmbeddingService
- 调用第三方Embedding服务（如OpenAI ADA-002）
- 支持批量生成Embedding
- 缓存Embedding结果

### 4.2 LLMService
- 调用大模型服务进行要素抽取
- 支持不同大模型提供商
- 实现重试机制

### 4.3 ChromaService
- 初始化Chroma客户端
- 存储和查询Embedding向量
- 管理Chroma集合

### 4.4 MemoryService
- 记忆的增删改查
- 记忆访问时间更新
- 记忆状态管理

### 4.5 ExtractionService
- 基于大模型的要素抽取
- 支持自定义抽取提示词
- 异步处理抽取任务

### 4.6 MergeService
- 定期检查重复记忆
- 基于相似度合并记忆
- 更新合并后的记忆Embedding

### 4.7 CleanupService
- 定期清理过期记忆
- 支持多种清理策略
- 同时清理SQLite和Chroma数据

## 5. 核心流程

### 5.1 聊天历史提交流程
1. 接收聊天历史请求
2. 存储聊天历史到ChatHistory表
3. 调用LLMService进行要素抽取
4. 调用EmbeddingService生成Embedding
5. 存储记忆到UserMemory表
6. 存储Embedding到Chroma和MemoryEmbedding表
7. 触发重复记忆合并检查
8. 返回记忆ID

### 5.2 记忆查询流程
1. 接收查询请求
2. 调用EmbeddingService生成查询向量
3. 调用ChromaService查询相似记忆
4. 更新记忆的最后访问时间
5. 返回查询结果

### 5.3 重复记忆合并流程
1. 定时任务触发
2. 按用户ID和app_name分组获取记忆
3. 计算记忆间的相似度
4. 合并相似度超过阈值的记忆
5. 更新合并后的记忆
6. 删除重复记忆
7. 更新Embedding

### 5.4 过期记忆清理流程
1. 定时任务触发
2. 根据配置的过期策略查询过期记忆
3. 删除过期记忆
4. 从Chroma中删除对应的Embedding

## 6. 配置设计

### 6.1 全局配置
- Embedding服务配置（API密钥、模型名称）
- 大模型服务配置（API密钥、模型名称、温度）
- Chroma配置（服务地址、集合名称）
- 定时任务配置（合并频率、清理频率）

### 6.2 应用级配置
- 要素抽取提示词
- 重复合并阈值（0-1）
- 过期策略（never/last_access）
- 过期天数

## 7. 轻量化设计考虑

1. **异步处理**: 要素抽取、Embedding生成等耗时操作采用异步处理
2. **缓存机制**: 缓存Embedding结果，避免重复调用
3. **定时任务**: 合并和清理任务采用轻量级定时调度
4. **懒加载**: Chroma客户端按需初始化
5. **批量处理**: 支持批量提交和查询，减少API调用次数
6. **内存优化**: 大模型调用结果及时释放，避免内存泄漏

## 8. 大厂规范实现

1. **代码结构清晰**: 模块化设计，职责分离
2. **类型提示**: 完整的Type hints
3. **错误处理**: 统一的异常处理机制
4. **日志记录**: 详细的日志记录
5. **API文档**: 自动生成的Swagger文档
6. **测试覆盖**: 单元测试和集成测试
7. **配置管理**: 环境变量和配置文件分离
8. **安全措施**: API密钥验证、输入验证

## 9. 扩展考虑

1. **支持多租户**: 通过user_id和app_name实现多租户隔离
2. **插件化设计**: 支持不同的大模型和Embedding服务
3. **监控告警**: 增加监控指标和告警机制
4. **分布式支持**: 后续可扩展到分布式部署
5. **多模态支持**: 支持文本、图像等多模态记忆
6. **增量更新**: 支持记忆的增量更新

## 10. 依赖列表

- fastapi
- uvicorn
- sqlalchemy
- sqlite3
- chromadb
- openai
- python-dotenv
- pydantic
- schedule
- asyncio
- numpy

以上设计方案遵循了轻量化、大厂规范和明确的接口设计原则，同时保留了扩展能力，能够满足用户基于大模型的记忆系统需求。